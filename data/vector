var tracts = ee.FeatureCollection("projects/nasa-eej/assets/tract_for_webtool");
var tract_layer = ui.Map.FeatureViewLayer("projects/nasa-eej/assets/tract_featureview",null,"Tracts",false);
var highlight_layer = ui.Map.FeatureViewLayer("projects/nasa-eej/assets/tract_featureview",null,"Highlighting",false);

var bin_style = require("users/dawnschumacher/nasa-eej:style/bin-style")
var legend_style = require("users/dawnschumacher/nasa-eej:style/legend-style")

var var1 = ["None", "Degree of Greenness", "Land Surface Temperature"]
var var2 = ["None", "Displacement Risk", "Social Vulnerability", "Average Housing Price Increase"]

var color_pal = [
  ['1_3', '#f73593'],
  ['2_3', '#a53593'],
  ['3_3', '#403593'],
  ['1_2', '#f78fb6'],
  ['2_2', '#a58fb6'],
  ['3_2', '#408fa7'],
  ['1_1', '#f7fcf5'],
  ['2_1', '#a5e8cd'],
  ['3_1', '#40dba7'],
  ['1_NA', '#FFFFFF'],
  ['2_NA', '#FFFFFF'],
  ['3_NA', '#FFFFFF']
];

var opacity_pal = [
  ['1_3', 0.7],
  ['2_3', 0.7],
  ['3_3', 0.7],
  ['1_2', 0.7],
  ['2_2', 0.7],
  ['3_2', 0.7],
  ['1_1', 0.7],
  ['2_1', 0.7],
  ['3_1', 0.7],
  ['1_NA', 0],
  ['2_NA', 0],
  ['3_NA', 0],
  ['NA_1', 0],
  ['NA_2', 0],
  ['NA_3', 0],
  ['NA_NA', 0]
];

function to_dict(palette) {
  var dict = {};
  
  for(var i = 0; i < palette.length; i++) {
    dict[palette[i][0]] = palette[i][1]
  }
  
  return dict;
}

// Returns a layer with all of the census tracts colored correctly to represent the data.
function get_vis_params(value) {
  
  var id = tract_data[value].id
  var palette = tract_data[value].palette
  
  return {
    polygonFillColor: {
      property: id,
      defaultValue: '#FFFFFF',
      categories: palette
    },
    
    polygonStrokeWidth: 0.5,
    
    opacity: {
      property: id,
      defaultValue: 0.7,
      categories: opacity_pal
    }
  }
}

function get_highlight(highlighted_tract) {
  
  return {
    polygonFillOpacity: 0,
    
    polygonStrokeWidth: {
      property: "GEOID",
      defaultValue: 0,
      categories: [[highlighted_tract, 2]]
    }
  }
}

var tract_data = {
  "Degree of Greenness and Displacement Risk" : {
    id : "ne",
    palette: color_pal,
    info : "Degree of greenness compared to level of displacement risk in 2019 (from Estimated Displacement Risk model) at the census tract level. Degree of greenness is defined using the median normalized difference vegetation index (NDVI; source: Landsat). NDVI is a unitless measure of vegetation health between -1 and 1."
  },
  "Degree of Greenness and Social Vulnerability" : {
    id : "ns",
    palette: color_pal,
    info : "Degree of greenness in 2019 compared to CDC's 2018 Social Vulnerability Index at the census tract level. Degree of greenness is defined using the median normalized difference vegetation index (NDVI; source: Landsat). NDVI is a unitless measure of vegetation health between -1 and 1."
  },
  "Degree of Greenness and Average Housing Price Increase" : {
    id : "nshp",
    palette: color_pal,
    info : "Rate of change in greenness (1990 - 2019) & percent change in yearly average housing price (2000 - 2020) at the zip code level. Degree of greenness is defined using the median normalized difference vegetation index (NDVI; source: Landsat). NDVI is a unitless measure of vegetation health between -1 and 1. Only zip codes with statistically significant (p < 0.05) greenness trends are shown."
  },
  "Land Surface Temperature and Displacement Risk" : {
    id : "le",
    palette: color_pal,
    info : "Median land surface temperature (LST; source: Landsat) compared to displacement risk in 2019 (from Estimated Displacement Risk model) at the census tract level."
  },
  "Land Surface Temperature and Social Vulnerability" : {
    id : "ls",
    palette: color_pal,
    info : "Median land surface temperature (LST; source: Landsat) in 2019 compared to CDC's 2018 Social Vulnerability Index at the census tract level."
  },
  "Land Surface Temperature and Average Housing Price Increase" : {
    id : "lshp",
    palette: color_pal,
    info : "Rate of change in land surface temperature (LST; source: Landsat) from 1990 to 2019 compared to percent change in yearly average housing price from 2000 to 2020 at the zip code level. Only zip codes with statistically significant (p < 0.05) land surface temperature trends are shown."
  }
}

tract_layer.setVisParams(get_vis_params("Degree of Greenness and Displacement Risk"));
highlight_layer.setVisParams(get_highlight(""));

function get_square(color) {
  return ui.Panel({
    style : {
      height: "16px",
      width: "16px",
      
      backgroundColor: color
    }
  })
}

function get_matrix(var1, var2, categories) {

  var category_dict = to_dict(categories);

  // This is the worst, least readable code I've ever written.
  return ui.Panel({
    widgets: [
  
      // Upper Container
      ui.Panel({
        
        widgets: [
          // Columns
          ui.Panel({
            widgets : [
              
              // Rows
              ui.Panel({
                widgets : [
                  get_square(category_dict["1_3"]),
                  get_square(category_dict["2_3"]),
                  get_square(category_dict["3_3"])
                ],
                layout: ui.Panel.Layout.flow("horizontal")
              }),
              ui.Panel({
                widgets : [
                  get_square(category_dict["1_2"]),
                  get_square(category_dict["2_2"]),
                  get_square(category_dict["3_2"])
                ],
                layout: ui.Panel.Layout.flow("horizontal")
              }),
              ui.Panel({
                widgets : [
                  get_square(category_dict["1_1"]),
                  get_square(category_dict["2_1"]),
                  get_square(category_dict["3_1"])
                ],
                layout: ui.Panel.Layout.flow("horizontal")
              })
            ],
            layout: ui.Panel.Layout.flow("vertical")
          }),
          
          // Right-side Label
          ui.Label({
            value: "↑ " + var2,
            style: legend_style.bivariate_label_right
          })
        ],
        
        style: legend_style.category_container,
        layout: ui.Panel.Layout.flow("horizontal")
      }),
      
      // Lower Label
      ui.Label({
        value: "→ " + var1,
        style: legend_style.bivariate_label_bottom
      })
    ],
    
    style: legend_style.category_container,
    layout: ui.Panel.Layout.flow("vertical")
  });
}

function get_bin_grid(var1, var2, categories) {
  
  var bin_grid = ui.Panel({
    style: bin_style.grid
  })
  bin_grid.setLayout(ui.Panel.Layout.flow("horizontal", false));
  
  for(var i = 0; i < 7; i++) {
    
    // Cross
    if(i % 2 === 0) {
    }
    
    // Squares
    else {
      
    }
  }
}

exports.tracts = tracts
exports.tract_layer = tract_layer
exports.highlight_layer = highlight_layer
exports.data = tract_data

exports.get_vis_params = get_vis_params
exports.get_highlight = get_highlight
exports.get_matrix = get_matrix

exports.var1 = var1
exports.var2 = var2